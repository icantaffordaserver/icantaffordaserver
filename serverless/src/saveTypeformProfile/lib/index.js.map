{"version":3,"file":"index.js","sources":["webpack:///webpack/bootstrap eb794e898e87d5aafae6","webpack:///external \"axios\"","webpack:///external \"graphql-fetch\"","webpack:///../../config/webpackInclude.js","webpack:///src/index.js","webpack:///src/helpers.js","webpack:///external \"babel-polyfill\"","webpack:///external \"lodash\""],"sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// identity function for calling harmony imports with the correct context\n \t__webpack_require__.i = function(value) { return value; };\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 7);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap eb794e898e87d5aafae6","module.exports = require(\"axios\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"axios\"\n// module id = 0\n// module chunks = 0","module.exports = require(\"graphql-fetch\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"graphql-fetch\"\n// module id = 1\n// module chunks = 0","/**\n * Created by alexandermann on 2017-05-04.\n */\n// Catch all unhandled exceptions and print their stack trace.\n// Required if the hanlder function is async, as promises\n// can swallow error messages.\n\nprocess.on('uncaughtException', err => console.error('uncaught exception:', err))\nprocess.on('unhandledRejection', error => console.error('unhandled rejection:', error))\n\n\n\n// WEBPACK FOOTER //\n// ../../config/webpackInclude.js","/**\n * Created by alexandermann on 2017-04-30.\n */\nimport 'babel-polyfill'\nimport axios from 'axios'\nimport client from 'graphql-fetch'\n\nimport { findResponse, parseProfileResponse } from './helpers'\n\nexport default async (event, context, callback) => {\n  const adminToken = process.env.ADMIN_TOKEN\n  const scapholdUrl = process.env.SCAPHOLD_URL\n  const typeformAPIKey = process.env.TYPEFORM_API_KEY\n  const formId = process.env.PROFILE_FORM_ID\n\n  const requestBody = JSON.parse(event.body)\n  const since = requestBody.created - 1 // subtract 1 second to make sure we get the response\n  const typeformApiURL = `https://api.typeform.com/v1/form/${formId}?key=${typeformAPIKey}&completed=true&since=${since}&order_by[]=date_submit,desc`\n\n  try {\n    const apiResponse = await axios.get(typeformApiURL)\n    const response = findResponse(requestBody, apiResponse.data.responses)\n    const profileResponses = parseProfileResponse(response, apiResponse.data.questions)\n    // the JSON object format\n    const profileDataStore = {\n      userId: response.hidden.user_id,\n      responseId: response.hidden.response_id,\n      dateLand: response.metadata.date_land,\n      dateSubmit: response.metadata.date_submit,\n      profileResponses,\n    }\n    const graphqlFetch = client(scapholdUrl, adminToken) // initialize the graphql fetch client\n    // store the profile json to the database\n    await graphqlFetch(\n      `\n        mutation addTypeformProfile($id: ID!, $typeformProfile: JSON!) {\n          updateUser(input: {id: $id, typeformProfile: $typeformProfile, typeformProfileComplete: true}) {\n            clientMutationId\n          }\n        }\n      `,\n      {\n        id: response.hidden.user_id,\n        typeformProfile: { ...profileDataStore },\n      },\n    )\n    context.succeed({ statusCode: 200 })\n  } catch (error) {\n    console.error(error)\n    context.fail(error)\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// src/index.js","/**\n * Created by alexandermann on 2017-02-10.\n */\nimport axios from 'axios'\nimport _ from 'lodash'\nimport graphqlFetch from 'graphql-fetch'\n\n/**\n * Takes in all recent typeform responses and finds the one matching the user submission\n * @param webHookRequest\n * @param typeformDataApiResponses\n * @returns Response\n */\nexport function findResponse(webHookRequest, typeformDataApiResponses) {\n  const { user_id: webHookUserId, response_id: webHookResponseId } = webHookRequest\n\n  for (let i = 0; i < typeformDataApiResponses.length; i += 1) {\n    const { user_id: typeformUserId, response_id: typeformResponseId } = typeformDataApiResponses[\n      i\n    ].hidden\n    // check that the responseId from the webhook equals the one stored in the typeform database\n    // and that the user id also matches\n    if (webHookUserId === typeformUserId && webHookResponseId === typeformResponseId) {\n      return typeformDataApiResponses[i]\n    }\n  }\n  return Error('No response found')\n}\n\n/**\n * Take the form response, find the relating questions and parse a complete object with details\n * the questions into something that is readable and makes sense\n * @param response\n * @param typeformDataApiQuestions\n * @returns {{}}\n */\n// Answers object looks like..\n// { listimage_42481899_choice: 'Deep',\n//   listimage_42483105_choice_53890487: 'Books',\n//   listimage_42483105_choice_53890490: 'The meaning of life',\n//   list_42487351_choice_53896250: 'An increase in energy',\n//   list_42487351_choice_53896252: 'A fresh perspective',\n//   textarea_42487449: 'Something cool',\n//   textarea_42487463: 'Marshawnnnnn' }\nexport function parseProfileResponse(response, typeformDataApiQuestions) {\n  const profile = {}\n  // loop through the answers object on the response body\n  _.forOwn(response.answers, (value, key) => {\n    // find the index of the corresponding answer id to the question id\n    const questionIndex = _.findIndex(typeformDataApiQuestions, question => {\n      return key === question.id\n    })\n    // build the parsed profile question and answer object\n    // check if question key already exists in the profile data structure\n    if (_.has(profile, typeformDataApiQuestions[questionIndex].field_id)) {\n      // key exists, push answer to answer array\n      profile[typeformDataApiQuestions[questionIndex].field_id].answer.push(value)\n    } else {\n      // key doesn't exist, create new question answer object\n      profile[typeformDataApiQuestions[questionIndex].field_id] = {\n        questionText: typeformDataApiQuestions[questionIndex].question,\n        answer: [value],\n      }\n    }\n  })\n  return profile\n}\n\n\n\n// WEBPACK FOOTER //\n// src/helpers.js","module.exports = require(\"babel-polyfill\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"babel-polyfill\"\n// module id = 5\n// module chunks = 0","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 6\n// module chunks = 0"],"mappings":";;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;A;;;;AChEA;;;;;;ACCA;;;;;;;;;ACCA;;;AAGA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;;;;;;;;;;;;;;;ACLA;AACA;AAAA;AACA;;;AAAA;AACA;;;AACA;AACA;;;AARA;;;;;;AASA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAAA;AARA;AAAA;AAAA;AACA;AADA;AAWA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AALA;AAOA;AACA;AACA;AAxBA;AAAA;AAiCA;AACA;AAFA;AACA;AAjCA;AAqCA;AArCA;AAAA;AACA;AADA;AAAA;AAAA;AACA;AAsCA;AACA;AACA;AAzCA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;;;;;;;;;;;;;;;;ACGA;AA+BA;AACA;AA1CA;AACA;;;AAAA;AACA;;;AAAA;AACA;;;;;AACA;;;;;;AAMA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAIA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;AAOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AA3CA;;;AA4CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAFA;AAIA;AACA;AACA;AACA;;;;;;AClEA;;;;;;ACCA;;;;;;;;;;;A","sourceRoot":""}